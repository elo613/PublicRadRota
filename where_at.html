<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Registrar Daily Schedule</title>
<style>
    body {
        font-family: Arial, sans-serif;
        background: #f5f5f5;
        padding: 20px;
    }
    .container {
        max-width: 900px;
        margin: 0 auto;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        padding: 20px;
    }
    h1 {
        text-align: center;
        margin-bottom: 15px;
        color: #2c3e50;
    }
    .date-controls {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 15px;
        margin-bottom: 20px;
    }
    button {
        background: #34495e;
        border: none;
        color: white;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9rem;
    }
    button:hover {
        background: #4a5f7a;
    }
    #currentDate {
        font-weight: bold;
        font-size: 1.2rem;
        min-width: 180px;
        text-align: center;
    }
    table {
        width: 100%;
        border-collapse: collapse;
    }
    thead tr {
        background: #34495e;
        color: white;
    }
    th, td {
        border: 1px solid #ddd;
        padding: 10px;
        text-align: center;
        font-size: 0.95rem;
    }
    tbody tr:nth-child(even) {
        background: #f9f9f9;
    }
    .status-leave {
        background: #f8d7da;
        color: #721c24;
        font-weight: bold;
    }
    .status-duty {
        background: #d4edda;
        color: #155724;
        font-weight: bold;
    }
    .status-reporting {
        background: #fff3cd;
        color: #856404;
        font-weight: bold;
    }
    .status-block {
        background: #cce5ff;
        color: #004085;
        font-weight: bold;
    }
    .status-none {
        color: #6c757d;
    }
    .weekend-indicator {
        text-align: center;
        padding: 12px;
        background: #17a2b8;
        color: white;
        font-weight: bold;
        margin-bottom: 15px;
        border-radius: 6px;
    }
    .loading, .error-message {
        text-align: center;
        padding: 20px;
        font-size: 1.1rem;
        border-radius: 6px;
        margin: 20px 0;
    }
    .loading {
        color: #6c757d;
    }
    .error-message {
        background: #f8d7da;
        color: #721c24;
    }
</style>
</head>
<body>
<div class="container">
    <h1>Registrar Daily Schedule</h1>
    <div class="date-controls">
        <button onclick="changeDate(-1)">← Previous</button>
        <div id="currentDate"></div>
        <button onclick="changeDate(1)">Next →</button>
    </div>
    <div id="scheduleContainer">
        <div class="loading">Loading schedule...</div>
    </div>
</div>

<script>
    let registrarsData = [];
    let rotaData = [];
    let blocksData = [];
    let currentDate = new Date();

    const DATA_SOURCES = {
        registrars: './registrars_data.json',
        rota: './rota.json',
        blocks: './blocks.json'
    };

    async function fetchData(url) {
        const response = await fetch(url);
        if (!response.ok) throw new Error(`Failed to load ${url}`);
        return await response.json();
    }

    function formatDate(date) {
        return date.toLocaleDateString('en-US', {
            weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
        });
    }

    function formatDateForRota(date) {
        const d = date.getDate().toString().padStart(2, '0');
        const m = (date.getMonth() + 1).toString().padStart(2, '0');
        const y = date.getFullYear();
        return `${d}/${m}/${y}`;
    }

    function formatDateForISO(date) {
        return date.toISOString().split('T')[0];
    }

    function isDateInRange(checkDate, start, end) {
        const c = new Date(checkDate);
        return c >= new Date(start) && c <= new Date(end);
    }

    // Get registrar's leave covering current date
    function checkLeave(registrar, dateISO) {
        for (const leave of registrar.leave_records) {
            if (isDateInRange(dateISO, leave.start, leave.end)) {
                return leave.type + " Leave";
            }
        }
        return null;
    }

    // Extract block description dynamically from blocksData JSON by specialty/day/session
    function getBlockDescription(registrar, dateISO, dayName, session) {
        const currentBlock = registrar.blocks.find(block =>
            isDateInRange(dateISO, block.start_date, block.end_date)
        );
        if (!currentBlock) return null;

        const specialty = currentBlock.block_name;
        if (!specialty) return null;

        if (
            blocksData[specialty] &&
            blocksData[specialty][dayName] &&
            blocksData[specialty][dayName][session] &&
            blocksData[specialty][dayName][session].value
        ) {
            return blocksData[specialty][dayName][session].value;
        }

        return null;
    }

    // Check rota for a specific date and session ('AM' or 'PM')
    // Returns "Duty", "Reporting" or null
    function checkRota(registrarName, dateStr, session) {
        for (const day of rotaData) {
            if (day.Date === dateStr) {
                const shifts = day.Shifts;
                if (shifts[session]) {
                    if (shifts[session].Duty === registrarName) return "Duty";
                    if (shifts[session].Reporting === registrarName) return "Reporting";
                }
            }
        }
        return null;
    }

    function isWeekend(dayOfWeek) {
        return dayOfWeek === 0 || dayOfWeek === 6;
    }

    function getSessionStatus(registrar, date, session, isWeekend) {
        const dateISO = formatDateForISO(date);
        const dateStr = formatDateForRota(date);
        const dayName = date.toLocaleDateString('en-US', { weekday: 'long' });

        // Weekend logic: only show duty/reporting if AAU duty in AM
        if (isWeekend) {
            if (session === 'AM') {
                const rotaStatus = checkRota(registrar.name, dateStr, session);
                if (rotaStatus === "Duty") {
                    return {text: "Duty", cssClass: "status-duty"};
                }
                if (rotaStatus === "Reporting") {
                    return {text: "Reporting", cssClass: "status-reporting"};
                }
                // Show AAU block if applicable
                const blockDesc = getBlockDescription(registrar, dateISO, dayName, session);
                if (blockDesc && registrar.blocks.some(b => b.block_name === "AAU" && isDateInRange(dateISO, b.start_date, b.end_date))) {
                    return {text: blockDesc, cssClass: "status-block"};
                }
                return {text: "-", cssClass: "status-none"};
            }
            return {text: "-", cssClass: "status-none"};
        }

        // Weekday priority: Leave > Duty/Reporting > Block > None

        const leaveStatus = checkLeave(registrar, dateISO);
        if (leaveStatus) return {text: leaveStatus, cssClass: 'status-leave'};

        const rotaStatus = checkRota(registrar.name, dateStr, session);
        if (rotaStatus === "Duty") {
            return {text: "Duty", cssClass: "status-duty"};
        }
        if (rotaStatus === "Reporting") {
            return {text: "Reporting", cssClass: "status-reporting"};
        }

        const blockDesc = getBlockDescription(registrar, dateISO, dayName, session);
        if (blockDesc) {
            return {text: blockDesc, cssClass: "status-block"};
        }

        return {text: "-", cssClass: "status-none"};
    }

    function renderSchedule() {
        const container = document.getElementById('scheduleContainer');
        const currentDateElem = document.getElementById('currentDate');
        currentDateElem.textContent = formatDate(currentDate);

        const dayOfWeek = currentDate.getDay();
        const weekend = isWeekend(dayOfWeek);

        let html = '';

        if (weekend) {
            html += `<div class="weekend-indicator">Weekend Schedule: only AM AAU duty/reporting shown; otherwise '-'</div>`;
        }

        html += `<table>
            <thead>
                <tr>
                    <th>Registrar</th>
                    <th>AM</th>
                    <th>PM</th>
                </tr>
            </thead>
            <tbody>`;

        registrarsData.forEach(registrar => {
            const amStatus = getSessionStatus(registrar, currentDate, "AM", weekend);
            const pmStatus = getSessionStatus(registrar, currentDate, "PM", weekend);

            html += `<tr>
                <td>${registrar.name}</td>
                <td class="${amStatus.cssClass}">${amStatus.text}</td>
                <td class="${pmStatus.cssClass}">${pmStatus.text}</td>
            </tr>`;
        });

        html += `</tbody></table>`;

        container.innerHTML = html;
    }

    async function initializeApp() {
        try {
            registrarsData = await fetchData(DATA_SOURCES.registrars);
            rotaData = await fetchData(DATA_SOURCES.rota);
            blocksData = await fetchData(DATA_SOURCES.blocks);

            renderSchedule();
        } catch (error) {
            document.getElementById('scheduleContainer').innerHTML = `<div class="error-message">Failed to load schedule data.</div>`;
            console.error(error);
        }
    }

    function changeDate(days) {
        currentDate.setDate(currentDate.getDate() + days);
        renderSchedule();
    }

    window.addEventListener('DOMContentLoaded', initializeApp);
</script>
</body>
</html>
