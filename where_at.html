<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Registrar Weekly Rota</title>
<style>
    body {
        font-family: Arial, sans-serif;
        background: #f5f5f5;
        padding: 20px;
    }
    .container {
        max-width: 1200px; /* Increased max-width for weekly view */
        margin: 0 auto;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        padding: 20px;
    }
    h1 {
        text-align: center;
        margin-bottom: 15px;
        color: #2c3e50;
    }
    .date-controls {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 15px;
        margin-bottom: 20px;
    }
    button {
        background: #34495e;
        border: none;
        color: white;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9rem;
    }
    button:hover {
        background: #4a5f7a;
    }
    #currentWeekRange {
        font-weight: bold;
        font-size: 1.2rem;
        min-width: 300px; /* Adjusted width for week range */
        text-align: center;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        table-layout: fixed; /* Ensures even column distribution */
    }
    thead tr {
        background: #34495e;
        color: white;
    }
    th, td {
        border: 1px solid #ddd;
        padding: 10px;
        text-align: center;
        font-size: 0.85rem; /* Slightly smaller font for more content */
        white-space: pre-line;
        vertical-align: top; /* Align content to top for multi-line cells */
    }
    tbody tr:nth-child(even) {
        background: #f9f9f9;
    }
    .day-header {
        background: #5c7b9e; /* Different background for day headers */
        color: white;
        font-weight: bold;
        padding: 8px;
    }
    .session-cell {
        min-height: 40px; /* Ensure consistent cell height */
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .status-leave {
        background: #f8d7da;
        color: #721c24;
        font-weight: bold;
    }
    .status-duty {
        background: #d4edda;
        color: #155724;
        font-weight: bold;
    }
    .status-reporting {
        background: #fff3cd;
        color: #856404;
        font-weight: bold;
    }
    .status-block {
        background: #cce5ff;
        color: #004085;
        font-weight: bold;
    }
    .status-none {
        color: #6c757d;
    }
    .weekend-indicator {
        text-align: center;
        padding: 12px;
        background: #17a2b8;
        color: white;
        font-weight: bold;
        margin-bottom: 15px;
        border-radius: 6px;
    }
    .loading, .error-message {
        text-align: center;
        padding: 20px;
        font-size: 1.1rem;
        border-radius: 6px;
        margin: 20px 0;
    }
    .loading {
        color: #6c757d;
    }
    .error-message {
        background: #f8d7da;
        color: #721c24;
    }
</style>
</head>
<body>
<div class="container">
    <h1>Registrar Weekly Rota</h1>
    <div class="date-controls">
        <button onclick="changeWeek(-7)">← Previous Week</button>
        <div id="currentWeekRange"></div>
        <button onclick="changeWeek(7)">Next Week →</button>
    </div>
    <div id="rotaContainer">
        <div class="loading">Loading rota...</div>
    </div>
</div>

<script>
    let registrarsData = [];
    let rotaData = [];
    let blocksData = {};
    let currentMonday = new Date(); // Will store the Monday of the current week

    const DATA_SOURCES = {
        registrars: './registrars_data.json',
        rota: './rota.json',
        blocks: './blocks.json'
    };

    async function fetchData(url) {
        const response = await fetch(url);
        if (!response.ok) throw new Error(`Failed to load ${url}`);
        return await response.json();
    }

    function formatDate(date) {
        return date.toLocaleDateString('en-US', {
            month: 'short', day: 'numeric'
        });
    }

    function formatFullDate(date) {
        return date.toLocaleDateString('en-US', {
            weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
        });
    }

    function formatDateForRota(date) {
        const d = date.getDate().toString().padStart(2, '0');
        const m = (date.getMonth() + 1).toString().padStart(2, '0');
        const y = date.getFullYear();
        return `${d}/${m}/${y}`;
    }

    function formatDateForISO(date) {
        return date.toISOString().split('T')[0];
    }

    // Parse leave dates like "16 Sep 2024"
    function parseLeaveDate(dateStr) {
        return new Date(dateStr);
    }

    // Inclusive date range check for leave and blocks
    function isDateInRange(checkDateStr, startStr, endStr) {
        const check = new Date(checkDateStr + 'T00:00:00');
        const start = parseLeaveDate(startStr);
        const end = parseLeaveDate(endStr);
        end.setHours(23, 59, 59, 999);
        return check >= start && check <= end;
    }

    // Check if registrar is on leave on the given date
    function checkLeave(registrar, dateISO) {
        for (const leave of registrar.leave_records) {
            if (isDateInRange(dateISO, leave.start, leave.end)) {
                return leave.type + " Leave";
            }
        }
        return null;
    }

    // Check block info for the registrar on given date and session
    function checkBlock(registrar, date, session) {
        const dateISO = formatDateForISO(date);
        const dayNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
        const dayName = dayNames[date.getDay()];

        for (const block of registrar.blocks) {
            if (isDateInRange(dateISO, block.start_date, block.end_date)) {
                const blockName = block.block_name;
                if (
                    blocksData[blockName] &&
                    blocksData[blockName][dayName] &&
                    blocksData[blockName][dayName][session] &&
                    blocksData[blockName][dayName][session].value
                ) {
                    return blocksData[blockName][dayName][session].value;
                }
                return `Block: ${blockName}`;
            }
        }
        return null;
    }

    // Check rota for a specific date and session ('AM' or 'PM')
    // Returns "Duty", "Reporting" or null
    function checkRota(registrarName, dateStr, session) {
        for (const day of rotaData) {
            if (day.Date === dateStr) {
                const shifts = day.Shifts;
                if (shifts[session]) {
                    if (shifts[session].Duty === registrarName) return "Duty";
                    if (shifts[session].Reporting === registrarName) return "Reporting";
                }
            }
        }
        return null;
    }

    // Compose status text and CSS class for a session
    function getSessionStatus(registrar, date, session) {
        const dateISO = formatDateForISO(date);
        const dateStr = formatDateForRota(date);
        const dayOfWeek = date.getDay();
        const isWeekend = (dayOfWeek === 0 || dayOfWeek === 6);

        if (isWeekend) {
            // Weekend logic: only show AM Duty/Reporting if AAU duty; else "-"
            if (session === 'AM') {
                const rotaStatus = checkRota(registrar.name, dateStr, session);
                if (rotaStatus === "Duty") {
                    return {text: "AAU Duty", cssClass: "status-duty"};
                }
                if (rotaStatus === "Reporting") {
                    return {text: "AAU Reporting", cssClass: "status-reporting"};
                }
            }
            return {text: "-", cssClass: "status-none"};
        }

        // Weekday priority: Leave > Duty/Reporting > Block > None

        // Leave check
        const leaveStatus = checkLeave(registrar, dateISO);
        if (leaveStatus) return {text: leaveStatus, cssClass: 'status-leave'};

        // Duty/Reporting check
        const rotaStatus = checkRota(registrar.name, dateStr, session);
        if (rotaStatus === "Duty") {
            return {text: "AAU Duty", cssClass: "status-duty"};
        }
        if (rotaStatus === "Reporting") {
            return {text: "AAU Reporting", cssClass: "status-reporting"};
        }

        // Block check - pass session now
        const blockStatus = checkBlock(registrar, date, session);
        if (blockStatus) return {text: blockStatus, cssClass: "status-block"};

        // None assigned
        return {text: "-", cssClass: "status-none"};
    }

    function renderWeeklyRota() {
        const rotaContainer = document.getElementById('rotaContainer');
        const currentWeekRangeElem = document.getElementById('currentWeekRange');

        // Calculate the dates for the current week (Monday to Sunday)
        let weekDates = [];
        const startOfWeek = new Date(currentMonday); // Copy currentMonday
        for (let i = 0; i < 7; i++) {
            const date = new Date(startOfWeek);
            date.setDate(startOfWeek.getDate() + i);
            weekDates.push(date);
        }

        // Update the week range display
        const mondayFormatted = formatFullDate(weekDates[0]);
        const sundayFormatted = formatFullDate(weekDates[6]);
        currentWeekRangeElem.textContent = `${mondayFormatted} - ${sundayFormatted}`;

        let html = '';

        // Add a weekend indicator only if the current week includes a weekend
        const hasWeekend = weekDates.some(date => date.getDay() === 0 || date.getDay() === 6);
        if (hasWeekend) {
            html += `<div class="weekend-indicator">Weekend Schedule: only AM AAU duty/reporting shown; otherwise '-'</div>`;
        }

        html += `<table>
            <thead>
                <tr>
                    <th>Registrar</th>`;
        weekDates.forEach(date => {
            const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
            const dateNum = date.getDate().toString().padStart(2, '0');
            const monthName = date.toLocaleDateString('en-US', { month: 'short' });
            html += `<th colspan="2" class="day-header">${dayName}<br>${dateNum} ${monthName}</th>`;
        });
        html += `</tr>
                <tr>
                    <th></th>`; // Empty cell for registrar column
        for (let i = 0; i < 7; i++) {
            html += `<th>AM</th><th>PM</th>`;
        }
        html += `</tr>
            </thead>
            <tbody>`;

        registrarsData.forEach(registrar => {
            html += `<tr>
                <td>${registrar.name}</td>`;
            weekDates.forEach(date => {
                const amStatus = getSessionStatus(registrar, date, "AM");
                const pmStatus = getSessionStatus(registrar, date, "PM");
                html += `<td class="${amStatus.cssClass} session-cell">${amStatus.text}</td>
                         <td class="${pmStatus.cssClass} session-cell">${pmStatus.text}</td>`;
            });
            html += `</tr>`;
        });

        html += `</tbody></table>`;

        rotaContainer.innerHTML = html;
    }

    // Function to set currentMonday to the Monday of the current week
    function setWeekToCurrentMonday(date) {
        const dayOfWeek = date.getDay(); // 0 for Sunday, 1 for Monday, etc.
        const diff = date.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1); // Adjust if current day is Sunday
        currentMonday = new Date(date.setDate(diff));
        currentMonday.setHours(0, 0, 0, 0); // Normalize to start of day
    }

    async function initializeApp() {
        try {
            registrarsData = await fetchData(DATA_SOURCES.registrars);
            rotaData = await fetchData(DATA_SOURCES.rota);
            blocksData = await fetchData(DATA_SOURCES.blocks);

            setWeekToCurrentMonday(new Date()); // Initialize to current week's Monday
            renderWeeklyRota();
        } catch (error) {
            document.getElementById('rotaContainer').innerHTML = `<div class="error-message">Failed to load rota data.</div>`;
            console.error(error);
        }
    }

    function changeWeek(days) {
        currentMonday.setDate(currentMonday.getDate() + days);
        renderWeeklyRota();
    }

    window.addEventListener('DOMContentLoaded', initializeApp);
</script>
</body>
</html>
