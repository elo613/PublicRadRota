<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Registrar Weekly Rota</title>
<style>
    body {
        font-family: Arial, sans-serif;
        background: #f5f5f5;
        padding: 20px;
    }
    .container {
        max-width: 1400px; /* Increased max-width for even wider weekly view */
        margin: 0 auto;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        padding: 20px;
    }
    h1 {
        text-align: center;
        margin-bottom: 15px;
        color: #2c3e50;
    }
    .date-controls {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 15px;
        margin-bottom: 20px;
    }
    button {
        background: #34495e;
        border: none;
        color: white;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9rem;
    }
    button:hover {
        background: #4a5f7a;
    }
    #currentWeekRange {
        font-weight: bold;
        font-size: 1.2rem;
        min-width: 300px;
        text-align: center;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        table-layout: fixed; /* Ensures even column distribution */
    }
    thead tr {
        background: #34495e;
        color: white;
    }
    th, td {
        border: 1px solid #ddd;
        padding: 8px; /* Slightly reduced padding */
        text-align: center;
        font-size: 0.8rem; /* Further reduced font size for many columns */
        white-space: pre-line;
        vertical-align: top;
    }
    tbody tr:nth-child(even) {
        background: #f9f9f9;
    }
    .day-header {
        background: #5c7b9e;
        color: white;
        font-weight: bold;
        padding: 6px; /* Adjusted padding */
    }
    .session-header {
        font-size: 0.75rem; /* Smaller font for AM/PM in second header row */
    }
    .session-cell {
        min-height: 40px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }
    .shift-detail {
        font-size: 0.7em; /* Smaller font for secondary details */
        color: #555;
        margin-top: 2px;
    }
    .status-leave {
        background: #f8d7da;
        color: #721c24;
        font-weight: bold;
    }
    .status-duty {
        background: #d4edda;
        color: #155724;
        font-weight: bold;
    }
    .status-reporting {
        background: #fff3cd;
        color: #856404;
        font-weight: bold;
    }
    .status-block {
        background: #cce5ff;
        color: #004085;
        font-weight: bold;
    }
    .status-ultrasound {
        background: #d1ecf1;
        color: #0c5460;
        font-weight: bold;
    }
    .status-none {
        color: #6c757d;
    }
    .weekend-indicator {
        text-align: center;
        padding: 12px;
        background: #17a2b8;
        color: white;
        font-weight: bold;
        margin-bottom: 15px;
        border-radius: 6px;
    }
    .loading, .error-message {
        text-align: center;
        padding: 20px;
        font-size: 1.1rem;
        border-radius: 6px;
        margin: 20px 0;
    }
    .loading {
        color: #6c757d;
    }
    .error-message {
        background: #f8d7da;
        color: #721c24;
    }
</style>
</head>
<body>
<div class="container">
    <h1>Registrar Weekly Rota</h1>
    <div class="date-controls">
        <button onclick="changeWeek(-7)">← Previous Week</button>
        <div id="currentWeekRange"></div>
        <button onclick="changeWeek(7)">Next Week →</button>
    </div>
    <div id="rotaContainer">
        <div class="loading">Loading rota...</div>
    </div>
</div>

<script>
    let registrarsData = [];
    let rotaData = [];
    let blocksData = {};
    let ultrasoundData = [];
    let currentMonday = new Date();

    const DATA_SOURCES = {
        registrars: './registrars_data.json',
        rota: './rota.json',
        blocks: './blocks.json',
        ultrasound: './ultrasound.json'
    };

    async function fetchData(url) {
        const response = await fetch(url);
        if (!response.ok) throw new Error(`Failed to load ${url}`);
        return await response.json();
    }

    function formatFullDate(date) {
        return date.toLocaleDateString('en-US', {
            weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
        });
    }

    function formatDateForRota(date) {
        const d = date.getDate().toString().padStart(2, '0');
        const m = (date.getMonth() + 1).toString().padStart(2, '0');
        const y = date.getFullYear();
        return `${d}/${m}/${y}`;
    }

    function formatDateForISO(date) {
        return date.toISOString().split('T')[0];
    }

    function parseLeaveDate(dateStr) {
        // Ensure dateStr is parsed as UTC to avoid timezone issues when comparing
        const parts = dateStr.match(/(\d{1,2}) ([A-Za-z]{3}) (\d{4})/);
        if (parts) {
            const day = parseInt(parts[1], 10);
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const month = monthNames.indexOf(parts[2]);
            const year = parseInt(parts[3], 10);
            return new Date(Date.UTC(year, month, day));
        }
        return new Date(dateStr); // Fallback, though parsing "16 Sep 2024" directly should work in modern browsers
    }

    // Inclusive date range check for leave and blocks
    function isDateInRange(checkDateStr, startStr, endStr) {
        const check = new Date(checkDateStr + 'T00:00:00');
        const start = parseLeaveDate(startStr);
        const end = parseLeaveDate(endStr);
        end.setUTCHours(23, 59, 59, 999); // Set end of day in UTC for inclusive range

        // Normalize check date to UTC for consistent comparison
        const checkUTC = new Date(Date.UTC(check.getFullYear(), check.getMonth(), check.getDate()));

        return checkUTC >= start && checkUTC <= end;
    }

    function checkLeave(registrar, dateISO) {
        for (const leave of registrar.leave_records) {
            if (isDateInRange(dateISO, leave.start, leave.end)) {
                return leave.type + " Leave";
            }
        }
        return null;
    }

    function checkBlock(registrar, date, session) {
        const dateISO = formatDateForISO(date);
        const dayNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
        const dayName = dayNames[date.getDay()]; // getDay() returns 0 for Sunday, 1 for Monday etc.

        for (const block of registrar.blocks) {
            if (isDateInRange(dateISO, block.start_date, block.end_date)) {
                const blockName = block.block_name;
                if (
                    blocksData[blockName] &&
                    blocksData[blockName][dayName] &&
                    blocksData[blockName][dayName][session] &&
                    blocksData[blockName][dayName][session].value
                ) {
                    return blocksData[blockName][dayName][session].value;
                }
                return `Block: ${blockName}`;
            }
        }
        return null;
    }

    function checkRota(registrarName, dateStr, session) {
        for (const day of rotaData) {
            if (day.Date === dateStr) {
                const shifts = day.Shifts;
                if (shifts[session]) {
                    if (shifts[session].Duty === registrarName) return "Duty";
                    if (shifts[session].Reporting === registrarName) return "Reporting";
                }
            }
        }
        return null;
    }

    function checkUltrasoundDuty(registrarName, dateStr, session) {
        for (const entry of ultrasoundData) {
            if (entry.Date === dateStr && entry.Session === session && entry['Registrar name'] === registrarName) {
                return "Ultrasound";
            }
        }
        return null;
    }

    function getSessionStatus(registrar, date, session) {
        const dateISO = formatDateForISO(date);
        const dateStr = formatDateForRota(date);
        const dayOfWeek = date.getDay();
        const isWeekend = (dayOfWeek === 0 || dayOfWeek === 6);

        // For weekends, only AAU duties are generally shown. Ultrasound is generally weekday.
        if (isWeekend) {
            const rotaStatus = checkRota(registrar.name, dateStr, session);
            if (rotaStatus === "Duty") {
                return {text: "AAU Duty", cssClass: "status-duty"};
            }
            if (rotaStatus === "Reporting") {
                return {text: "AAU Reporting", cssClass: "status-reporting"};
            }
             // While uncommon for weekend, still check ultrasound just in case
            const ultrasoundStatus = checkUltrasoundDuty(registrar.name, dateStr, session);
            if (ultrasoundStatus) {
                 return {text: "Ultrasound", cssClass: "status-ultrasound"};
            }
            return {text: "-", cssClass: "status-none"};
        }

        // Weekday priority: Leave > Duty/Reporting > Ultrasound > Block > None

        const leaveStatus = checkLeave(registrar, dateISO);
        if (leaveStatus) return {text: leaveStatus, cssClass: 'status-leave'};

        const rotaStatus = checkRota(registrar.name, dateStr, session);
        if (rotaStatus === "Duty") {
            return {text: "AAU Duty", cssClass: "status-duty"};
        }
        if (rotaStatus === "Reporting") {
            return {text: "AAU Reporting", cssClass: "status-reporting"};
        }

        const ultrasoundStatus = checkUltrasoundDuty(registrar.name, dateStr, session);
        if (ultrasoundStatus) {
            return {text: "Ultrasound", cssClass: "status-ultrasound"};
        }

        const blockStatus = checkBlock(registrar, date, session);
        if (blockStatus) return {text: blockStatus, cssClass: "status-block"};

        return {text: "-", cssClass: "status-none"};
    }

    function renderWeeklyRota() {
        const rotaContainer = document.getElementById('rotaContainer');
        const currentWeekRangeElem = document.getElementById('currentWeekRange');

        let weekDates = [];
        const startOfWeek = new Date(currentMonday); // This is already the Monday
        for (let i = 0; i < 7; i++) {
            const date = new Date(startOfWeek);
            date.setDate(startOfWeek.getDate() + i);
            weekDates.push(date);
        }

        const mondayFormatted = formatFullDate(weekDates[0]);
        const sundayFormatted = formatFullDate(weekDates[6]);
        currentWeekRangeElem.textContent = `${mondayFormatted} - ${sundayFormatted}`;

        let html = '';

        const hasWeekend = weekDates.some(date => date.getDay() === 0 || date.getDay() === 6);
        if (hasWeekend) {
            html += `<div class="weekend-indicator">Weekend Schedule: only AM AAU duty/reporting shown; otherwise '-'</div>`;
        }

        html += `<table>
            <thead>
                <tr>
                    <th rowspan="2">Registrar</th>`; // Registrar header spans two rows
        weekDates.forEach(date => {
            const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
            const dateNum = date.getDate().toString().padStart(2, '0');
            const monthName = date.toLocaleDateString('en-US', { month: 'short' });
            html += `<th colspan="2" class="day-header">${dayName}<br>${dateNum} ${monthName}</th>`;
        });
        html += `</tr>
                <tr>`;
        // Second header row for AM/PM
        for (let i = 0; i < 7; i++) {
            html += `<th class="session-header">AM</th><th class="session-header">PM</th>`;
        }
        html += `</tr>
            </thead>
            <tbody>`;

        registrarsData.forEach(registrar => {
            html += `<tr>
                <td>${registrar.name}</td>`; // Registrar name in the first column
            weekDates.forEach(date => {
                const amStatus = getSessionStatus(registrar, date, "AM");
                const pmStatus = getSessionStatus(registrar, date, "PM");
                html += `<td class="${amStatus.cssClass} session-cell">${amStatus.text}</td>
                         <td class="${pmStatus.cssClass} session-cell">${pmStatus.text}</td>`;
            });
            html += `</tr>`;
        });

        html += `</tbody></table>`;

        rotaContainer.innerHTML = html;
    }

    function setWeekToCurrentMonday(date) {
        const dayOfWeek = date.getDay(); // 0 = Sunday, 1 = Monday, ..., 6 = Saturday
        // Calculate the difference to get to the preceding Monday
        // If it's Sunday (0), subtract 6 days. Otherwise, subtract (dayOfWeek - 1) days.
        const diff = date.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
        currentMonday = new Date(date.setDate(diff));
        currentMonday.setHours(0, 0, 0, 0); // Normalize to start of day
    }

    async function initializeApp() {
        try {
            registrarsData = await fetchData(DATA_SOURCES.registrars);
            rotaData = await fetchData(DATA_SOURCES.rota);
            blocksData = await fetchData(DATA_SOURCES.blocks);
            ultrasoundData = await fetchData(DATA_SOURCES.ultrasound);

            // Set the initial week to the current week's Monday
            setWeekToCurrentMonday(new Date());
            renderWeeklyRota();
        } catch (error) {
            document.getElementById('rotaContainer').innerHTML = `<div class="error-message">Failed to load rota data.</div>`;
            console.error(error);
        }
    }

    function changeWeek(days) {
        currentMonday.setDate(currentMonday.getDate() + days);
        renderWeeklyRota();
    }

    window.addEventListener('DOMContentLoaded', initializeApp);
</script>
</body>
</html>
