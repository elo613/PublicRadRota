<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registrar Daily Rota</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .table-container { max-height: 80vh; }
        table { min-width: 100%; border-collapse: collapse; }
        thead th { position: sticky; top: 0; z-index: 2; }
        th:first-child, td:first-child { position: sticky; left: 0; z-index: 1; }
        thead th:first-child { z-index: 3; }
        /* Custom styles for the status classes */
        .status-leave { background: #dc3545; color: white; font-weight: bold; }
        .status-duty { background: #28a745; color: white; font-weight: bold; }
        .status-reporting { background: #007bff; color: white; font-weight: bold; }
        .status-block { background: #17a2b8; color: white; font-weight: bold; }
        .status-ultrasound { background: #6f42c1; color: white; font-weight: bold; }
        .status-none { color: #6c757d; font-style: italic; }
        .status-additional { background: #ffc107; color: #343a40; font-weight: bold; }
        .status-mt-vernon-oncology { background: #e6f7ff; color: #0056b3; font-weight: bold; }
        .status-wgh-reporting-duty { background: #dff0d8; color: #3c763d; font-weight: bold; }
    </style>
</head>
<body class="bg-gray-100">

    <div class="container max-w-7xl mx-auto bg-white rounded-lg shadow-xl p-6 mt-10">
        <h1 class="text-center text-3xl font-bold mb-4 text-gray-800">Registrar Daily Rota</h1>
        <div class="flex justify-center items-center gap-4 mb-6">
            <button onclick="rotaApp.changeDay(-1)" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors duration-200">← Previous Day</button>
            <div id="currentDayDisplay" class="font-bold text-xl min-w-40 text-center">Loading...</div>
            <button onclick="rotaApp.changeDay(1)" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors duration-200">Next Day →</button>
            <button onclick="rotaApp.copyTable()" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors duration-200">Copy Table</button>
        </div>
        <div id="rotaContainer" class="table-container overflow-auto border rounded-md">
            <div class="text-center p-5 text-gray-500 text-lg">Loading rota...</div>
        </div>
    </div>

    <div id="messageModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg shadow-xl text-center max-w-sm">
            <p id="modalMessage" class="text-lg font-semibold mb-4"></p>
            <button onclick="document.getElementById('messageModal').classList.add('hidden')" class="bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700">OK</button>
        </div>
    </div>
    
    <script>
        class RotaApp {
            constructor() {
                // currentDate now represents the single day being displayed
                this.currentDate = new Date();
                // Data sources for the original weekly rota
                this.DATA_SOURCES = {
                    registrars: './registrars_data.json',
                    rota: './rota.json',
                    blocks: './blocks.json',
                };
                this.registrarsData = [];
                this.processedRota = new Map();
                this.processedBlocks = new Map();
                this.CSS_STATUS_CLASSES = {
                    'Leave': 'status-leave',
                    'AAU Duty': 'status-duty',
                    'AAU Reporting': 'status-reporting',
                    'Ultrasound': 'status-ultrasound',
                    'Block': 'status-block',
                    'Mt Vernon Oncology': 'status-mt-vernon-oncology',
                    'WGH Reporting/Duty': 'status-wgh-reporting-duty',
                    'Additional': 'status-additional',
                    'None': 'status-none'
                };
            }

            async init() {
                try {
                    await this._loadAndProcessData();
                    this.render();
                } catch (e) {
                    console.error("Initialization error:", e);
                    this._showMessage('Failed to load rota data. Please try again later.');
                }
            }

            // Method to fetch data from the provided URLs
            async _fetchData(url) {
                const res = await fetch(url);
                if (!res.ok) throw new Error(`Failed to fetch ${url}`);
                return res.json();
            }

            // Method to load and process all data from the remote sources
            async _loadAndProcessData() {
                const [registrars, rota, blocks] = await Promise.all([
                    this._fetchData(this.DATA_SOURCES.registrars),
                    this._fetchData(this.DATA_SOURCES.rota),
                    this._fetchData(this.DATA_SOURCES.blocks)
                ]);
                this.registrarsData = registrars;
                this._processRotaData(rota);
                this._processBlocksData(registrars, blocks);
            }

            _processRotaData(data) {
                this.processedRota.clear();
                data.forEach(day => {
                    if (day.Date && day.Shifts) {
                        this.processedRota.set(day.Date, day.Shifts);
                    }
                });
            }

            _processBlocksData(registrars, blockDefs) {
                registrars.forEach(r => {
                    const blocks = [];
                    if (r.blocks) {
                        r.blocks.forEach(b => {
                            blocks.push({
                                start: new Date(b.start_date),
                                end: new Date(b.end_date),
                                blockName: b.block_name,
                                definition: blockDefs[b.block_name]
                            });
                        });
                    }
                    r.leave_records = r.leave_records?.map(l => ({
                        type: l.type,
                        start: new Date(l.start),
                        end: new Date(l.end)
                    })) || [];
                    this.processedBlocks.set(r.name, blocks);
                });
            }

            _normalizeDateToMidnight(d) {
                if (!d) return null;
                return new Date(d.getFullYear(), d.getMonth(), d.getDate());
            }

            _getAdditionalSessionStatus(registrarName, dateStr, session) {
                const dayShifts = this.processedRota.get(dateStr);
                if (dayShifts && dayShifts[session] && dayShifts[session].Additional) {
                    const additionalSessions = dayShifts[session].Additional;
                    for (const s of additionalSessions) {
                        if (s[0] === registrarName) {
                            return { text: `Manual: ${s[3]}`, cssClass: this.CSS_STATUS_CLASSES.Additional };
                        }
                    }
                }
                return null;
            }

            _getShiftStatus(registrar, date, session) {
                const dateStr = date.toLocaleDateString('en-GB');
                const dayOfWeek = date.toDateString().split(' ')[0];
                const normalizedCurrentDate = this._normalizeDateToMidnight(date);

                // 1. Check for Leave (Highest priority)
                if (registrar.leave_records.some(l => {
                    const normalizedLeaveStart = this._normalizeDateToMidnight(l.start);
                    const normalizedLeaveEnd = this._normalizeDateToMidnight(l.end);
                    return normalizedCurrentDate >= normalizedLeaveStart && normalizedCurrentDate <= normalizedLeaveEnd;
                })) {
                    const leaveRecord = registrar.leave_records.find(l => {
                        const normalizedLeaveStart = this._normalizeDateToMidnight(l.start);
                        const normalizedLeaveEnd = this._normalizeDateToMidnight(l.end);
                        return normalizedCurrentDate >= normalizedLeaveStart && normalizedCurrentDate <= normalizedLeaveEnd;
                    });
                    return { text: `${leaveRecord.type} Leave`, cssClass: this.CSS_STATUS_CLASSES.Leave };
                }

                const dayShifts = this.processedRota.get(dateStr);
                if (dayShifts && dayShifts[session]) {
                    const shift = dayShifts[session];
                    
                    // 2. Check for AAU Duty/Reporting and Ultrasound
                    if (shift.Duty && shift.Duty.includes(registrar.name)) return { text: "AAU Duty", cssClass: this.CSS_STATUS_CLASSES["AAU Duty"] };
                    if (shift.Reporting && shift.Reporting.includes(registrar.name)) return { text: "AAU Reporting", cssClass: this.CSS_STATUS_CLASSES["AAU Reporting"] };
                    if (shift.Ultrasound && shift.Ultrasound.includes(registrar.name)) return { text: "Ultrasound Duty", cssClass: this.CSS_STATUS_CLASSES.Ultrasound };
                }
                
                // 3. Check for Manual Sessions
                const additionalSession = this._getAdditionalSessionStatus(registrar.name, dateStr, session);
                if (additionalSession) {
                    return additionalSession;
                }
                
                // 4. Check for Block rotations, only on weekdays
                if (date.getDay() !== 0 && date.getDay() !== 6) { // 0 is Sunday, 6 is Saturday
                    const blocks = this.processedBlocks.get(registrar.name);
                    if (blocks) {
                        for (const b of blocks) {
                            const normalizedBlockStart = this._normalizeDateToMidnight(b.start);
                            const normalizedBlockEnd = this._normalizeDateToMidnight(b.end);
                            if (normalizedCurrentDate >= normalizedBlockStart && normalizedCurrentDate <= normalizedBlockEnd) {
                                const val = b.definition?.[dayOfWeek]?.[session]?.value;
                                return {
                                    text: val || `Block: ${b.blockName}`,
                                    cssClass: this.CSS_STATUS_CLASSES[val] || this.CSS_STATUS_CLASSES.Block
                                };
                            }
                        }
                    }
                }

                // 5. Default to a 'None' status if no other conditions are met
                return { text: "-", cssClass: this.CSS_STATUS_CLASSES.None };
            }

            // Function to change the current day
            changeDay(offset) {
                this.currentDate.setDate(this.currentDate.getDate() + offset);
                this.render();
            }

            render() {
                // Display the current day in the UI
                const currentDayDisplay = document.getElementById("currentDayDisplay");
                if (currentDayDisplay) {
                    currentDayDisplay.textContent = this.currentDate.toDateString();
                }

                let html = `<div class="table-container"><table id="rotaTable" class="w-full text-sm"><thead><tr>
                    <th class="p-3 bg-gray-800 text-white sticky top-0 left-0 z-30">Registrar</th>
                    <th colspan="2" class="p-3 bg-gray-800 text-white sticky top-0 z-20">${this.currentDate.toDateString()}</th>
                    </tr><tr>
                    <th class="p-3 bg-gray-700 text-white sticky left-0 z-10"></th>
                    <th class="p-3 bg-gray-700 text-white">AM</th>
                    <th class="p-3 bg-gray-700 text-white">PM</th>
                    </tr></thead><tbody>`;

                this.registrarsData.forEach((r, index) => {
                    const rowClass = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                    html += `<tr class="${rowClass}">
                        <td class="p-3 border sticky left-0 z-10 bg-white">${r.name}</td>`;
                        ["AM", "PM"].forEach(s => {
                            const status = this._getShiftStatus(r, this.currentDate, s);
                            html += `<td class="p-3 border ${status.cssClass}">${status.text}</td>`;
                        });
                    html += `</tr>`;
                });

                html += `</tbody></table></div>`;
                document.getElementById("rotaContainer").innerHTML = html;
            }

            _showMessage(message) {
                const modal = document.getElementById('messageModal');
                const modalMessage = document.getElementById('modalMessage');
                if (modal && modalMessage) {
                    modalMessage.textContent = message;
                    modal.classList.remove('hidden');
                }
            }

            // Custom method to copy table to clipboard using the custom modal
            async copyTable() {
                const table = document.getElementById('rotaTable');
                if (!table) {
                    this._showMessage('Rota table not found!');
                    return;
                }

                try {
                    const text = table.innerText;
                    await navigator.clipboard.writeText(text);
                    this._showMessage('Table copied to clipboard!');
                } catch (err) {
                    console.error('Error copying table: ', err);
                    this._showMessage('Failed to copy table. Your browser may not support this method.');
                }
            }
        }

        const rotaApp = new RotaApp();
        rotaApp.init();
    </script>
</body>
</html>
